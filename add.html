<!DOCTYPE html>
<html lang="zh-CN">
    <head>
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <title>新增活动 - 志愿活动管理系统</title>
        <link href="css/bootstrap.min.css" rel="stylesheet">
        <link href="css/bootstrap-icons.css" rel="stylesheet">
        <link href="css/font-awesome.min.css" rel="stylesheet">
    </head>
    <body>
        <main class="flex-shrink-0">
            <div class="container" id="body-container">
                <h1 class="mt-5">新增活动</h1>
            </div>
        </main>

        <script src="js/jquery-3.3.1.min.js"></script>
        <script src="js/bootstrap.bundle.min.js"></script>
        <script src="//code.bdstatic.com/npm/leancloud-storage@4.12.0/dist/av-min.js"></script>
        <script src="js/main.js"></script>
        <script>
            generateNavbar();
            generateBody(user => {
                if (user.get("isAdmin")) {
                    $("#body-container").append(`
                        <form class="mb-5 needs-validation" novalidate>
                            <div class="mb-3">
                                <label for="add-input-title" class="form-label">活动名称</label>
                                <input type="text" class="form-control" id="add-input-title" required>
                            </div>
                            <div class="mb-3" id="add-input-campus">
                                <label for="add-input-campus" class="form-label">所在校区</label>
                            </div>
                            <div class="mb-3">
                                <label for="add-input-site" class="form-label">活动地点</label>
                                <input type="text" class="form-control" id="add-input-site" required>
                            </div>
                            <div class="mb-3">
                                <label for="add-input-participantsLimit" class="form-label">人数限制</label>
                                <input type="number" class="form-control" id="add-input-participantsLimit" required>
                            </div>
                            <div class="mb-3">
                                <label for="add-input-desc" class="form-label">活动描述</label>
                                <textarea class="form-control" id="add-input-desc" rows="3"></textarea>
                            </div>
                            <div class="mb-3">
                                <label for="add-input-time" class="form-label">活动时间</label>
                                <input type="text" class="form-control" id="add-input-time" aria-describedby="time-help" required>
                                <div id="time-help" class="form-text">以 JSON 格式输入。例如：[{"start": 600, "end": "660", "loop": [0,6]}, {"start": 1200, "end": "1260", "loop": [1, 2, 3, 4, 5]}]</div>
                            </div>
                            <div class="mb-3 form-check">
                                <input type="checkbox" class="form-check-input" id="add-check" aria-describedby="check-help" required>
                                <label class="form-check-label" for="add-check">我确认以上信息无误。</label>
                                <div id="check-help" class="form-text">发布活动后，如想修改或删除活动，需联系工作人员。为节约您的时间，请确定以上信息无误。</div>
                            </div>
                            <button type="submit" class="btn btn-primary">提交</button>
                        </form>
                    `);
                    campuses.forEach((item, index) => {
                        $("#add-input-campus").append(`
                            <div class="form-check">
                                <input class="form-check-input" type="radio" name="add-radius-campus" id="add-radius-campus-${index}"
                                  value="${index}"${user.get("currentCampus") == index ? " checked" : ""}>
                                <label class="form-check-label" for="add-radius-campus-${index}">${item}</label>
                            </div>
                        `);
                    });

                    // Validation
                    var forms = document.querySelectorAll('.needs-validation');
                    Array.prototype.slice.call(forms).forEach(function (form) {
                        form.addEventListener('submit', function (event) {
                            event.preventDefault();
                            event.stopPropagation();
                            form.classList.add('was-validated');
                            if (form.checkValidity()) {
                                const activity = new AV.Object("Activity");
                                activity.set("title", $("#add-input-title").val());
                                activity.set("campus", Number($("input[type='radio']:checked").val()));
                                activity.set("site", $("#add-input-site").val());
                                activity.set("participantsLimit", Number($("#add-input-participantsLimit").val()));
                                if ($("#add-input-desc").val()) {
                                    activity.set("desc", $("#add-input-desc").val());
                                }
                                activity.set("time", $.parseJSON($("#add-input-time").val()));
                                activity.save().then((todo) => {
                                    alert("保存成功");
                                }, (error) => {
                                    alert(`${error.rawMessage} (Error ${error.code})`);
                                });
                            }
                        }, false);
                    });
                } else {
                    $("#body-container").append(`
                        <div class="alert alert-warning" role="alert">
                            <i class="bi bi-exclamation-circle-fill"></i>
                            只有管理员才能新增活动。
                        </div>
                    `);
                }
            });
        </script>
    </body>
</html>